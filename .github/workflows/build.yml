# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: build
on:
  push:
    branches:
      - "**"
      - "!main"
  workflow_dispatch:
    inputs:
      upload_artifacts:
        description: Upload build artifacts
        required: false
        default: false
        type: boolean
  workflow_call:
    inputs:
      upload_artifacts:
        description: Upload build artifacts
        required: false
        default: false
        type: boolean
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      self_mutation_happened: ${{ steps.self_mutation.outputs.self_mutation_happened }}
    env:
      CI: "true"
      NONPROD_AWS_ACCOUNT_ID: ${{ secrets.NONPROD_AWS_ACCOUNT_ID }}
      PROD_AWS_ACCOUNT_ID: ${{ secrets.PROD_AWS_ACCOUNT_ID }}
      NONPROD_HOSTED_ZONE: ${{ secrets.NONPROD_HOSTED_ZONE }}
      PROD_HOSTED_ZONE: ${{ secrets.PROD_HOSTED_ZONE }}
      VITE_NONPROD_HOSTED_ZONE: ${{ secrets.NONPROD_HOSTED_ZONE }}
      VITE_PROD_HOSTED_ZONE: ${{ secrets.PROD_HOSTED_ZONE }}
      AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
      VITE_AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
      AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
      DEPLOY_ENV: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: AWS Account Login
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::${{ secrets.NONPROD_AWS_ACCOUNT_ID }}:role/github-actions-deployer
      - name: Setup Auth0 Client IDs for Build
        env:
          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
          AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
          DEPLOY_ENV: dev
          PROD_HOSTED_ZONE: ${{ secrets.PROD_HOSTED_ZONE }}
          NONPROD_HOSTED_ZONE: ${{ secrets.NONPROD_HOSTED_ZONE }}
          VITE_PROD_HOSTED_ZONE: ${{ secrets.PROD_HOSTED_ZONE }}
          VITE_NONPROD_HOSTED_ZONE: ${{ secrets.NONPROD_HOSTED_ZONE }}
        run: |-
          echo "Setting up Auth0 client IDs for build environment..."
          # For non-production builds, only create/update the dev client
          # Production client should only be created during production deployment
          bun run scripts/manage-auth0-client.ts ensure-client-ids-for-build

          # Set up hosted zone environment variables for frontend build
          echo "📋 Setting up hosted zone environment variables..."
          export VITE_PROD_HOSTED_ZONE="${PROD_HOSTED_ZONE}"
          export VITE_NONPROD_HOSTED_ZONE="${NONPROD_HOSTED_ZONE}"

          # Source the .env file to make client IDs available for the build
          if [ -f .env ]; then
            echo "📋 Sourcing .env file for build environment variables..."
            set -a  # automatically export all variables
            source .env
            set +a  # stop automatically exporting
            
            # Override with hosted zones from secrets since they're more authoritative
            export VITE_PROD_HOSTED_ZONE="${PROD_HOSTED_ZONE}"
            export VITE_NONPROD_HOSTED_ZONE="${NONPROD_HOSTED_ZONE}"
            
            echo "✅ Environment variables loaded for build:"
            echo "   VITE_SPA_AUTH0_CLIENT_ID: ${VITE_SPA_AUTH0_CLIENT_ID:+[SET]}"
            echo "   VITE_PROD_HOSTED_ZONE: ${VITE_PROD_HOSTED_ZONE}"
            echo "   VITE_NONPROD_HOSTED_ZONE: ${VITE_NONPROD_HOSTED_ZONE}"
          else
            echo "❌ No .env file found"
          fi
      - name: build
        run: npx projen build
      - name: Upload CDK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cdk-out-${{ github.sha }}
          path: cdk.out/*
          retention-days: "30"
      - name: Find mutations
        id: self_mutation
        run: |-
          git add .
          git diff --staged --patch --exit-code > repo.patch || echo "self_mutation_happened=true" >> $GITHUB_OUTPUT
        shell: bash
        working-directory: ./
      - name: Upload patch
        if: steps.self_mutation.outputs.self_mutation_happened
        uses: actions/upload-artifact@v4.4.0
        with:
          name: repo.patch
          path: repo.patch
          overwrite: true
      - name: Fail build on mutation
        if: steps.self_mutation.outputs.self_mutation_happened
        run: |-
          echo "::error::Files were changed during build (see build log). If this was triggered from a fork, you will need to update your branch."
          cat repo.patch
          exit 1
  self-mutation:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: always() && needs.build.outputs.self_mutation_happened && !(github.event.pull_request.head.repo.full_name != github.repository)
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PROJEN_GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
      - name: Download patch
        uses: actions/download-artifact@v4
        with:
          name: repo.patch
          path: ${{ runner.temp }}
      - name: Apply patch
        run: '[ -s ${{ runner.temp }}/repo.patch ] && git apply ${{ runner.temp }}/repo.patch || echo "Empty patch. Skipping."'
      - name: Set git identity
        run: |-
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
      - name: Push changes
        env:
          PULL_REQUEST_REF: ${{ github.event.pull_request.head.ref }}
        run: |-
          git add .
          git commit -s -m "chore: self mutation"
          git push origin HEAD:$PULL_REQUEST_REF
