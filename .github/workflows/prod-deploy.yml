# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: prod-deploy
on:
  pull_request_target:
    types:
      - closed
    branches:
      - main
jobs:
  find_artifact:
    name: Find Build Artifact
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      pull-requests: read
    if: github.event.pull_request.merged == true
    steps:
      - name: Find build artifact
        id: find-artifact
        uses: actions/github-script@v7
        with:
          script: "

            \              // For PR events, we need both the head commit (where the build happened)

            \              // and the merge commit (what's in the main branch)

            \              const headSha = context.eventName === 'pull_request_target'

            \                ? context.payload.pull_request.head.sha  // The PR's last commit, where the build ran

            \                : context.sha;

            \             \ 

            \              const mergeCommitSha = context.eventName === 'pull_request_target'

            \                ? context.payload.pull_request.merge_commit_sha  // The squash commit in main

            \                : null;

            \             \ 

            \              console.log('Event type:', context.eventName);

            \              console.log('Event action:', context.payload.action);

            \              console.log('Looking for builds:', {

            \                headSha,

            \                mergeCommitSha

            \              });

            \             \ 

            \              if (context.eventName === 'pull_request_target') {

            \                console.log('PR details:', {

            \                  number: context.payload.pull_request.number,

            \                  title: context.payload.pull_request.title,

            \                  merged: context.payload.pull_request.merged,

            \                  merge_commit_sha: context.payload.pull_request.merge_commit_sha,

            \                  head_sha: context.payload.pull_request.head.sha,

            \                  base_sha: context.payload.pull_request.base.sha

            \                });

            \              }

            \             \ 

            \              // First, find the build workflow

            \              const workflows = await github.rest.actions.listRepoWorkflows({

            \                owner: context.repo.owner,

            \                repo: context.repo.repo,

            \              });

            \             \ 

            \              const buildWorkflow = workflows.data.workflows.find(w => w.name === 'build');

            \              if (!buildWorkflow) {

            \                throw new Error('Could not find build workflow');

            \              }

            \             \ 

            \              // Get workflow runs for the target commit

            \              const runs = await github.rest.actions.listWorkflowRuns({

            \                owner: context.repo.owner,

            \                repo: context.repo.repo,

            \                workflow_id: buildWorkflow.id,

            \              });

            \             \ 

            \              console.log('Found workflow runs:', runs.data.workflow_runs.map(r =>\ 

            \                `${r.head_sha} (${r.status})`).join(', '));


            \              // Find the successful run for our target commit

            \              const successRun = runs.data.workflow_runs.find(r =>\ 

            \                (r.head_sha === headSha || r.head_sha === mergeCommitSha) &&\ 

            \                r.status === 'completed' &&\ 

            \                r.conclusion === 'success'

            \              );

            \             \ 

            \              if (!successRun) {

            \                const errorDetails = [

            \                  `No successful build found for ${context.eventName === 'pull_request_target' ? 'PR' : 'commit'}`,

            \                  `Event: ${context.eventName}`

            \                ];


            \                if (context.eventName === 'pull_request_target') {

            \                  errorDetails.push(

            \                    `PR: #${context.payload.pull_request.number} - ${context.payload.pull_request.title}`,

            \                    `Head commit (expected build): ${headSha}`,

            \                    `Squash commit: ${mergeCommitSha}`

            \                  );

            \                } else {

            \                  errorDetails.push(`Commit: ${headSha}`);

            \                }


            \                errorDetails.push(

            \                  'Available workflow runs:',

            \                  ...runs.data.workflow_runs.map(r => `  ${r.head_sha} (${r.status}/${r.conclusion})`)

            \                );


            \                throw new Error(errorDetails.join('\\n'));

            \              }

            \             \ 

            \              console.log('Found successful build run:', {

            \                id: successRun.id,

            \                sha: successRun.head_sha,

            \                status: successRun.status,

            \                conclusion: successRun.conclusion

            \              });


            \              // List artifacts for the successful run

            \              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({

            \                owner: context.repo.owner,

            \                repo: context.repo.repo,

            \                run_id: successRun.id,

            \              });


            \              // Look for artifacts with either the head SHA or merge commit SHA

            \              const cdkArtifact = artifacts.data.artifacts.find(a =>\ 

            \                a.name === `cdk-out-${headSha}` ||\ 

            \                (mergeCommitSha && a.name === `cdk-out-${mergeCommitSha}`)

            \              );

            \             \ 

            \              if (!cdkArtifact) {

            \                const expected = [

            \                  `cdk-out-${headSha}`,

            \                  ...(mergeCommitSha ? [`cdk-out-${mergeCommitSha}`] : [])

            \                ];

            \                throw new Error(

            \                  `No CDK artifact found. Expected one of:\\n  ${expected.join('\\n  ')}\\n` +

            \                  `Available artifacts:\\n  ${artifacts.data.artifacts.map(a => a.name).join('\\n  ')}`

            \                );

            \              }


            \              console.log('Found CDK artifact:', cdkArtifact.name);

            \              return JSON.stringify({

            \                artifactName: cdkArtifact.name,

            \                runId: successRun.id

            \              });

            \            "
      - name: Set artifact details
        run: |-
          RESULT=${{ steps.find-artifact.outputs.result }}
          echo "artifact-name=$(echo $RESULT | jq -r .artifactName)" >> $GITHUB_OUTPUT
          echo "run-id=$(echo $RESULT | jq -r .runId)" >> $GITHUB_OUTPUT
  deploy_production:
    name: Deploy to Production
    needs: find_artifact
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: read
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::${{ secrets.PROD_AWS_ACCOUNT_ID }}:role/github-actions-deployer
      - name: Download CDK artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.find_artifact.outputs.artifact-name }}
          path: cdk.out/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.find_artifact.outputs.run-id }}
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Deploy to Production
        run: bunx cdk deploy 'prod/*' --app cdk.out --require-approval never
      - name: Get Production URL
        id: get-prod-url
        run: |-
          URL=$(bunx cdk --app cdk.out --outputs-file prod-outputs.json deploy --require-approval never 2>/dev/null && cat prod-outputs.json | jq -r '.[] | select(.CloudFrontUrl) | .CloudFrontUrl' || echo "Deployment completed")
          echo "PROD_URL=$URL" >> $GITHUB_OUTPUT
      - name: Notify deployment success
        run: |-
          echo "ðŸŽ‰ Production deployment successful!"
          echo "URL: ${{ steps.get-prod-url.outputs.PROD_URL }}"
