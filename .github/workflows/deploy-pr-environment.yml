# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: deploy-pr-environment
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
concurrency:
  group: pr-deploy
  cancel-in-progress: false
env:
  DEPLOY_ENV: pr${{ github.event.number }}
  NONPROD_AWS_ACCOUNT_ID: ${{ secrets.NONPROD_AWS_ACCOUNT_ID }}
  PROD_AWS_ACCOUNT_ID: ${{ secrets.PROD_AWS_ACCOUNT_ID }}
  NONPROD_HOSTED_ZONE: ${{ secrets.NONPROD_HOSTED_ZONE }}
  PROD_HOSTED_ZONE: ${{ secrets.PROD_HOSTED_ZONE }}
  AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
  VITE_AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
  AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
  AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
  DEPLOY_EPHEMERAL: "true"
jobs:
  deploy_pr:
    name: Deploy PR Environment
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: read
      pull-requests: write
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - id: build
        uses: ./.github/actions/build
        with:
          upload_artifacts: true
      - name: Generate CDK Diff
        id: cdk-diff
        run: |-
          echo "Stack Changes:" > cdk-diff.txt
          echo "" >> cdk-diff.txt
          bunx cdk diff "prod/*" --app cdk.out "$DEPLOY_ENV/*" > cdk-diff-raw.txt 2>&1 || true
          # Obfuscate sensitive information
          cat cdk-diff-raw.txt | sed -E "s/[0-9]{12}/XXXX-ACCOUNT-ID-XXXX/g" | sed -E "s/${{ secrets.NONPROD_AWS_ACCOUNT_ID }}/XXXX-NONPROD-ACCOUNT-ID-XXXX/g" | sed -E "s/${{ secrets.PROD_AWS_ACCOUNT_ID }}/XXXX-PROD-ACCOUNT-ID-XXXX/g" | sed -E "s/\$\{\{ secrets.NONPROD_HOSTED_ZONE \}\}/nonprod.example.com/g" | sed -E "s/\$\{\{ secrets.PROD_HOSTED_ZONE \}\}/example.com/g" > cdk-diff.txt
          echo "CDK_DIFF_CONTENT<<EOF" >> $GITHUB_OUTPUT
          cat cdk-diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          rm cdk-diff-raw.txt
      - name: Deploy PR environment
        id: deploy
        run: bunx projen deploy "$DEPLOY_ENV/*" --require-approval never --outputs-file outputs.json
      - name: Extract deployment URLs
        id: get-urls
        run: |-
          # Extract API URL
          API_URL=$(cat outputs.json | jq -r '.[]["ApiCustomDomainUrl"] // empty' | head -1)
          if [ -z "$API_URL" ] || [ "$API_URL" == "null" ]; then
            echo "‚ùå Failed to extract API URL from CDK outputs"
            echo "Available outputs:"
            cat outputs.json | jq -r 'to_entries[] | "\(.key): \(.value | keys_unsorted | join(", "))"'
            exit 1
          fi
          echo "‚úÖ Extracted API URL from outputs: $API_URL"
          echo "API_BASE_URL=$API_URL" >> $GITHUB_OUTPUT

          # Extract Frontend URL
          FRONTEND_URL=$(cat outputs.json | jq -r '.[]["WebsiteUrl"] // empty' | head -1)
          if [ -z "$FRONTEND_URL" ] || [ "$FRONTEND_URL" == "null" ]; then
            echo "‚ùå Failed to extract Frontend URL from CDK outputs"
            echo "Available outputs:"
            cat outputs.json | jq -r 'to_entries[] | "\(.key): \(.value | keys_unsorted | join(", "))"'
            exit 1
          fi
          echo "‚úÖ Extracted Frontend URL from outputs: $FRONTEND_URL"
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_OUTPUT
      - name: Find existing comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: "## üöÄ PR Environment Status"
      - name: Setup Integration Testing
        id: setup-integration-testing
        run: |-
          echo "Setting up integration testing environment..."
          bun run scripts/manage-auth0-client.js setup-integration-testing
      - name: Update Auth0 Client for PR Environment
        id: update-auth0-client
        env:
          AUTH0_ADDITIONAL_CALLBACK_URLS: ${{ steps.get-urls.outputs.FRONTEND_URL }}
        run: |-
          echo "Adding PR environment URL to Auth0 client callback URLs..."
          echo "PR Frontend URL: ${{ steps.get-urls.outputs.FRONTEND_URL }}"
          bun run scripts/manage-auth0-client.js ensure-client
      - name: Run Integration Tests
        id: integration-tests
        env:
          API_BASE_URL: ${{ steps.get-urls.outputs.API_BASE_URL }}
          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          VITE_AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
        run: |-
          echo "Running integration tests against PR environment..."
          echo "API URL: $API_BASE_URL"
          echo "Auth0 Domain: $AUTH0_DOMAIN"

          # Load Auth0 test credentials from .env file
          if [ -f .env ]; then
            echo "üìÑ .env file exists, extracting credentials..."
            echo "üìã All .env contents:"
            cat .env
            echo "üìã AUTH0_TEST lines:"
            grep "AUTH0_TEST" .env || echo "No AUTH0_TEST lines found"
            echo "üìã VITE_SPA lines:"
            grep "VITE_SPA" .env || echo "No VITE_SPA lines found"
            
            CLIENT_ID=$(grep "^AUTH0_TEST_CLIENT_ID=" .env | cut -d "=" -f2 || echo "MISSING")
            CLIENT_SECRET=$(grep "^AUTH0_TEST_CLIENT_SECRET=" .env | cut -d "=" -f2 || echo "MISSING")
            AUDIENCE=$(grep "^AUTH0_TEST_AUDIENCE=" .env | cut -d "=" -f2 || echo "MISSING")
            SPA_CLIENT_ID=$(grep "^VITE_SPA_AUTH0_CLIENT_ID=" .env | cut -d "=" -f2 || echo "MISSING")
            
            echo "‚úÖ Loaded Auth0 test credentials from .env file"
            echo "   M2M Client ID: $CLIENT_ID"
            echo "   SPA Client ID: $SPA_CLIENT_ID"
            echo "   Audience: $AUDIENCE"
            echo "   Client Secret: ${CLIENT_SECRET:+[REDACTED]}"
            echo "   Client Secret Length: ${#CLIENT_SECRET}"

            # Run integration tests with Auth0 credentials
            env AUTH0_TEST_CLIENT_ID="$CLIENT_ID" AUTH0_TEST_CLIENT_SECRET="$CLIENT_SECRET" AUTH0_TEST_AUDIENCE="$AUDIENCE" bun run test:integration
          else
            echo "‚ùå No .env file found"
            exit 1
          fi
      - name: Run E2E Tests
        id: e2e-tests
        env:
          BASE_URL: ${{ steps.get-urls.outputs.FRONTEND_URL }}
          VITE_AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          VITE_DEPLOY_ENV: ${{ env.DEPLOY_ENV }}
          VITE_DEPLOY_EPHEMERAL: "true"
          VITE_NONPROD_HOSTED_ZONE: ${{ secrets.NONPROD_HOSTED_ZONE }}
          VITE_PROD_HOSTED_ZONE: ${{ secrets.PROD_HOSTED_ZONE }}
          AUTH0_TEST_USER_EMAIL: ${{ secrets.AUTH0_TEST_USER_EMAIL }}
          AUTH0_TEST_USER_PASSWORD: ${{ secrets.AUTH0_TEST_USER_PASSWORD }}
        run: |-
          echo "Running E2E tests against PR environment..."
          echo "Frontend URL: ${{ steps.get-urls.outputs.FRONTEND_URL }}"
          echo "Deploy Environment: $VITE_DEPLOY_ENV"

          # Use cached browsers if possible to speed up installation
          bunx playwright install --with-deps chromium

          # Extract SPA client ID from .env for E2E tests
          if [ -f .env ]; then
            SPA_CLIENT_ID=$(grep "^VITE_SPA_AUTH0_CLIENT_ID=" .env | cut -d "=" -f2 || echo "")
            export VITE_SPA_AUTH0_CLIENT_ID="$SPA_CLIENT_ID"
            echo "üìã Using SPA Client ID for E2E auth: $SPA_CLIENT_ID"
          fi

          # Run only basic smoke tests first, then full suite
          echo "Running basic smoke tests first..."
          if ! bunx playwright test --project=chromium tests/e2e/basic-flow.spec.ts; then
            echo "‚ùå Basic tests failed, skipping remaining tests"
            exit 1
          fi

          echo "Basic tests passed, running full E2E suite..."
          bunx playwright test --project=chromium
      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |-
            ## üöÄ PR Environment Status

            **Environment:** `${{ env.DEPLOY_ENV }}`
            **Status:** ${{ steps.deploy.outcome == 'success' && '‚úÖ Deployed' || '‚ùå Failed' }}
            **URL:** ${{ steps.get-urls.outputs.FRONTEND_URL }}

            ### üß™ Test Results
            - **Integration Tests:** ${{ steps.integration-tests.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
            - **E2E Tests:** ${{ steps.e2e-tests.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}

            ### üìã CDK Prod Diff
            <details>
            <summary>Click to view infrastructure changes</summary>

            ```diff
            ${{ steps.cdk-diff.outputs.CDK_DIFF_CONTENT }}
            ```
            </details>
            ---
            *Last updated: ${{ github.event.head_commit.timestamp }}*
            *Commit: ${{ github.event.head_commit.id }}*
