# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: deploy-pr-environment
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
env:
  AWS_CDK_ENV_NAME: pr${{ github.event.number }}
  NONPROD_AWS_ACCOUNT_ID: ${{ secrets.NONPROD_AWS_ACCOUNT_ID }}
  PROD_AWS_ACCOUNT_ID: ${{ secrets.PROD_AWS_ACCOUNT_ID }}
  NONPROD_HOSTED_ZONE: ${{ secrets.NONPROD_HOSTED_ZONE }}
  PROD_HOSTED_ZONE: ${{ secrets.PROD_HOSTED_ZONE }}
jobs:
  deploy_pr:
    name: Deploy PR Environment
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::${{ secrets.NONPROD_AWS_ACCOUNT_ID }}:role/github-actions-deployer
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Wait for build workflow
        uses: actions/github-script@v7
        with:
          script: "

            \              async function waitForBuild() {

            \                const workflowName = 'build';

            \                const maxAttempts = 60;  // 10 minutes (60 * 10 seconds)

            \                const ref = context.sha;

            \               \ 

            \                for (let attempt = 0; attempt < maxAttempts; attempt++) {

            \                  console.log(`Checking build status (attempt ${attempt + 1}/${maxAttempts})`);

            \                 \ 

            \                  const builds = await github.rest.actions.listWorkflowRuns({

            \                    owner: context.repo.owner,

            \                    repo: context.repo.repo,

            \                    workflow_id: workflowName + '.yml',

            \                    head_sha: ref,

            \                  });

            \                 \ 

            \                  if (builds.data.workflow_runs.length > 0) {

            \                    const build = builds.data.workflow_runs[0];

            \                    console.log(`Build status: ${build.status}, conclusion: ${build.conclusion}`);

            \                   \ 

            \                    if (build.status === 'completed') {

            \                      if (build.conclusion === 'success') {

            \                        console.log('Build completed successfully');

            \                        return;

            \                      } else {

            \                        throw new Error(`Build failed with conclusion: ${build.conclusion}`);

            \                      }

            \                    }

            \                  }

            \                 \ 

            \                  await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds

            \                }

            \               \ 

            \                throw new Error('Timed out waiting for build to complete');

            \              }

            \             \ 

            \              return await waitForBuild();

            \            "
      - name: Download CDK artifacts
        uses: actions/download-artifact@v4
        with:
          name: cdk-out-pr-${{ github.event.number }}
          path: cdk.out/
      - name: CDK Bootstrap (if needed)
        run: bunx projen cdk-bootstrap --trust-for-lookup ${{ secrets.PROD_AWS_ACCOUNT_ID }}
      - name: Generate CDK Diff
        id: cdk-diff
        run: |-
          cdk diff --app cdk.out --context envName=pr${{ github.event.number }} > cdk-diff.txt 2>&1 || true
          echo "CDK_DIFF<<EOF" >> $GITHUB_OUTPUT
          cat cdk-diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Deploy ephemeral environment
        run: bunx projen deploy --app cdk.out --require-approval never
      - name: Get CloudFront URL
        id: get-url
        run: |-
          URL=$(cdk --app cdk.out --context envName=pr${{ github.event.number }} --outputs-file outputs.json deploy --require-approval never 2>/dev/null && cat outputs.json | jq -r '.[] | select(.CloudFrontUrl) | .CloudFrontUrl' || echo "Not available yet")
          echo "CLOUDFRONT_URL=$URL" >> $GITHUB_OUTPUT
  comment:
    name: Comment PR Environment Status and diff
    needs: deploy_pr
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Find existing comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: "## üöÄ PR Environment Status"
      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |-
            ## üöÄ PR Environment Status

            **Environment:** `pr${{ github.event.number }}`
            **Status:** ${{ needs.deploy_ephemeral.result == 'success' && '‚úÖ Deployed' || '‚ùå Failed' }}
            **Preview URL:** Deployment in progress...

            ### üìã CDK Diff
            <details>
            <summary>Click to view infrastructure changes</summary>

            ```diff
            CDK diff will be shown here
            ```
            </details>

            ### üîí Security Scan
            **Status:** ${{ needs.security.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}

            ---
            *Last updated: ${{ github.event.head_commit.timestamp }}*
            *Commit: ${{ github.event.head_commit.id }}*
