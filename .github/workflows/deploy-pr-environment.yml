# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: deploy-pr-environment
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
env:
  AWS_CDK_ENV_NAME: pr${{ github.event.number }}
  NONPROD_AWS_ACCOUNT_ID: ${{ secrets.NONPROD_AWS_ACCOUNT_ID }}
  PROD_AWS_ACCOUNT_ID: ${{ secrets.PROD_AWS_ACCOUNT_ID }}
  NONPROD_HOSTED_ZONE: ${{ secrets.NONPROD_HOSTED_ZONE }}
  PROD_HOSTED_ZONE: ${{ secrets.PROD_HOSTED_ZONE }}
jobs:
  deploy_pr:
    name: Deploy PR Environment
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: read
    outputs:
      CDK_DIFF: ${{ steps.cdk-diff.outputs.CDK_DIFF }}
      CLOUDFRONT_URL: ${{ steps.get-url.outputs.CLOUDFRONT_URL }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - id: build
        uses: ./.github/actions/build
        with:
          upload_artifacts: true
      - name: Generate CDK Diff
        id: cdk-diff
        run: |-
          echo "CDK_DIFF<<EOF" >> $GITHUB_OUTPUT
          echo "Stack Changes:" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          bunx cdk diff --app cdk.out "$AWS_CDK_ENV_NAME/*" >> $GITHUB_OUTPUT 2>&1 || true
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Deploy PR environment
        run: bunx projen deploy "$AWS_CDK_ENV_NAME/*" --require-approval never
      - name: Get CloudFront URL
        id: get-url
        run: |-
          URL=$(cdk --app cdk.out --context envName=pr${{ github.event.number }} --outputs-file outputs.json deploy --require-approval never 2>/dev/null && cat outputs.json | jq -r '.[] | select(.CloudFrontUrl) | .CloudFrontUrl' || echo "Not available yet")
          echo "CLOUDFRONT_URL=$URL" >> $GITHUB_OUTPUT
  comment:
    name: Comment PR Environment Status and diff
    needs: deploy_pr
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Find existing comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: "## üöÄ PR Environment Status"
      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |-
            ## üöÄ PR Environment Status

            **Environment:** `pr${{ github.event.number }}`
            **Status:** ${{ needs.deploy_pr.result == 'success' && '‚úÖ Deployed' || '‚ùå Failed' }}

            ### üìã CDK Diff
            <details>
            <summary>Click to view infrastructure changes</summary>

            ```diff
            ${{ needs.deploy_pr.outputs.CDK_DIFF || 'No infrastructure changes' }}
            ```
            </details>

            ### üîí Security Scan
            **Status:** ${{ needs.security.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}

            ---
            *Last updated: ${{ github.event.head_commit.timestamp }}*
            *Commit: ${{ github.event.head_commit.id }}*
